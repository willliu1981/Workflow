<?xml version="1.0" encoding="UTF-8"?>
<workflow id="elder_quest_5_stages" xmlns="http://kuan.studio/taskflow/1.0">

    <!-- 前置 -->
    <task id="p1" type="setVar" key="player" value="Kuanwei"/>
    <task id="p2" type="log" message="[Prologue] ${player} enters a foggy forest."/>

    <!-- Stage 1：遇到老人（選擇 1） -->
    <task id="s1_1" type="log" message="[Stage 1] An old man asks for help on the roadside."/>
    <task id="s1_2" type="choice"
        key="helpElder"
        prompt="Do you help the old man?"
        optionA="Help him" valueA="yes"
        optionB="Ignore him" valueB="no"/>
    <task id="s1_3" type="branch"
        ifEqualsKey="helpElder" ifEqualsValue="yes"
        thenGo="s1_good_1" elseGo="s1_bad_1"/>

    <task id="s1_good_1" type="log" message="[Stage 1] He gives you a small bronze key."/>
    <task id="s1_good_2" type="setVar" key="hasKey" value="true"/>
    <task id="s1_good_3" type="log" message="[Stage 1] He whispers: 'Kindness opens stone.'"/>

    <task id="s1_bad_1" type="log" message="[Stage 1] You walk away. The fog becomes heavier."/>
    <task id="s1_bad_2" type="setVar" key="hasKey" value="false"/>
    <task id="s1_bad_3" type="log" message="[Stage 1] You hear a distant bell..."/>

    <!-- Stage 2：洞穴（選擇 2） -->
    <task id="s2_1" type="log" message="[Stage 2] A cave blocks your path. Two tunnels appear."/>
    <task id="s2_2" type="choice"
        key="caveRoute"
        prompt="Which tunnel do you take?"
        optionA="Left tunnel (quiet)" valueA="left"
        optionB="Right tunnel (warm wind)" valueB="right"/>
    <task id="s2_3" type="branch"
        ifEqualsKey="caveRoute" ifEqualsValue="left"
        thenGo="s2_left_1" elseGo="s2_right_1"/>

    <task id="s2_left_1" type="log" message="[Stage 2] You find ancient carvings. You learn a clue: 'WATER'."/>
    <task id="s2_left_2" type="setVar" key="clueWord" value="WATER"/>

    <task id="s2_right_1" type="log" message="[Stage 2] You avoid bats but slip. You lose time."/>
    <task id="s2_right_2" type="setVar" key="clueWord" value=""/>

    <!-- Stage 3：河谷（選擇 3） -->
    <task id="s3_1" type="log" message="[Stage 3] A river blocks the road. There is a boat and a broken bridge."/>
    <task id="s3_2" type="choice"
        key="riverChoice"
        prompt="How do you cross the river?"
        optionA="Use the boat" valueA="boat"
        optionB="Try the broken bridge" valueB="bridge"/>
    <task id="s3_3" type="branch"
        ifEqualsKey="riverChoice" ifEqualsValue="boat"
        thenGo="s3_boat_1" elseGo="s3_bridge_1"/>

    <task id="s3_boat_1" type="log" message="[Stage 3] The boat is stable. You cross safely."/>
    <task id="s3_boat_2" type="setVar" key="isInjured" value="false"/>

    <task id="s3_bridge_1" type="log" message="[Stage 3] The bridge collapses. You get hurt but survive."/>
    <task id="s3_bridge_2" type="setVar" key="isInjured" value="true"/>

    <!-- Stage 4：石門（選擇 4，但會受 hasKey 影響） -->
    <task id="s4_1" type="log" message="[Stage 4] A stone gate asks: 'Show me your proof'."/>
    <task id="s4_2" type="branch"
        ifEqualsKey="hasKey" ifEqualsValue="true"
        thenGo="s4_key_1" elseGo="s4_noKey_1"/>

    <task id="s4_key_1" type="log" message="[Stage 4] You have the bronze key. The gate allows a secret shortcut."/>
    <task id="s4_key_2" type="choice"
        key="gateChoice"
        prompt="Do you use the key to open the secret shortcut?"
        optionA="Use the key" valueA="use_key"
        optionB="Save the key" valueB="save_key"/>

    <task id="s4_noKey_1" type="log" message="[Stage 4] You have no key. You must answer a riddle."/>
    <task id="s4_noKey_2" type="choice"
        key="gateChoice"
        prompt="The gate asks: 'What word was carved in the cave?'"
        optionA="WATER" valueA="answer_water"
        optionB="FIRE" valueB="answer_fire"/>

    <!-- Stage 5：結局（依 gateChoice + isInjured 走向不同 ending） -->
    <task id="s5_1" type="log" message="[Stage 5] Final path begins..."/>
    <task id="s5_2" type="branch"
        ifEqualsKey="gateChoice" ifEqualsValue="use_key"
        thenGo="ending_good_1" elseGo="s5_check_answer_1"/>

    <task id="s5_check_answer_1" type="branch"
        ifEqualsKey="gateChoice" ifEqualsValue="answer_water"
        thenGo="ending_good_1" elseGo="ending_bad_1"/>

    <task id="ending_good_1" type="log" message="[Ending] The gate opens. You reach the village."/>
    <task id="ending_good_2" type="branch"
        ifEqualsKey="isInjured" ifEqualsValue="true"
        thenGo="ending_good_injured_1" elseGo="ending_good_clean_1"/>

    <task id="ending_good_clean_1" type="log" message="[Ending] Perfect run. You unlock: 'Forest Explorer'."/>
    <task id="ending_good_clean_2" type="end"/>

    <task id="ending_good_injured_1" type="log" message="[Ending] You made it, but injured. You unlock: 'Survivor'."/>
    <task id="ending_good_injured_2" type="end"/>

    <task id="ending_bad_1" type="log" message="[Ending] The gate rejects you. Monsters surround the area."/>
    <task id="ending_bad_2" type="log" message="[Ending] You retreat. Try different choices next time."/>
    <task id="ending_bad_3" type="end"/>

</workflow>
